---
# tasks file for log
- name: Install java
  apt:
    name: default-jdk
    state: present
    update_cache: true
  tags: elk

- name: Copy deb files to server
  copy:
    src: "files/{{item}}"
    dest: /home/vagrant
  with_items:
    - "elasticsearch-{{ elk_version }}-amd64.deb"
    - "kibana-{{ elk_version }}-amd64.deb"
    - "logstash-{{ elk_version }}-amd64.deb"
  tags: elk

- name: Install ELK
  apt:
    deb: "/home/vagrant/{{ item }}"
  with_items:
    - "elasticsearch-{{ elk_version }}-amd64.deb"
    - "kibana-{{ elk_version }}-amd64.deb"
    - "logstash-{{ elk_version }}-amd64.deb"
  tags: elk

- name: Copy jvm.options
  copy:
    src: files/jvm.options
    dest: /etc/elasticsearch/jvm.options.d/jvm.options
    owner: root
    group: elasticsearch
    mode: 0660
  notify: Restart elasticsearch
  tags: elk

- name: Copy elasticsearch config
  copy:
    src: files/elasticsearch.yml
    dest: /etc/elasticsearch/elasticsearch.yml
    owner: root
    group: elasticsearch
    mode: 0660
  notify: Restart elasticsearch
  tags: elk

- name: Restart elasticsearch
  meta: flush_handlers
  tags: elk

- name: Start elasticsearch service
  systemd:
    name: elasticsearch
    state: started
    enabled: true
  tags: elk

- name: Copy kibana config
  copy:
    src: files/kibana.yml
    dest: /etc/kibana/kibana.yml
    owner: root
    group: kibana
    mode: 0660
  notify: Restart kibana
  tags: elk

- name: Restart kibana
  meta: flush_handlers
  tags: elk

- name: Start kibana service
  systemd:
    name: kibana
    state: started
    enabled: true
  tags: elk

- name: Install node exporter
  import_tasks: node_exporter.yml
